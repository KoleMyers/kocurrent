# Rocket.Chat + MongoDB + Jitsi Meet + Caddy on one 8GB host
# Usage: cp .env.example .env, set ROOT_URL, PUBLIC_URL, Jitsi passwords; edit Caddyfile domains; then:
#   docker compose up -d
# See DEPLOYMENT_PLAN.md for full steps.

services:
  # --- Caddy (reverse proxy, automatic HTTPS) ---
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - rocketchat
      - web
    networks:
      - backend
      - meet.jitsi
    deploy:
      resources:
        limits:
          memory: ${CADDY_MEMORY_LIMIT:-128m}

  # --- Rocket.Chat (text, channels, "Start call" -> Jitsi) ---
  rocketchat:
    image: ${ROCKETCHAT_IMAGE:-registry.rocket.chat/rocketchat/rocket.chat}:${RELEASE:-8.0.1}
    restart: unless-stopped
    environment:
      ROOT_URL: ${ROOT_URL:-http://localhost:3000}
      PORT: 3000
      MONGO_URL: mongodb://mongodb:27017/rocketchat?replicaSet=rs0
      DEPLOY_METHOD: docker
      DEPLOY_PLATFORM: compose
    expose:
      - "3000"
    depends_on:
      mongodb:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: ${ROCKETCHAT_MEMORY_LIMIT:-2g}
    networks:
      - backend

  # --- MongoDB (Rocket.Chat 8.x requires replica set) ---
  mongodb:
    image: mongodb/mongodb-community-server:${MONGODB_VERSION:-8.2}-ubi8
    restart: unless-stopped
    volumes:
      - mongodb_data:/data/db
    environment:
      MONGODB_REPLICA_SET_NAME: ${MONGODB_REPLICA_SET_NAME:-rs0}
      MONGODB_PORT_NUMBER: 27017
      MONGODB_INITIAL_PRIMARY_HOST: mongodb
    entrypoint: |
      bash -c "
      mongod --replSet $$MONGODB_REPLICA_SET_NAME --bind_ip_all &
      sleep 2;
      until mongosh --eval \"db.adminCommand('ping')\"; do
        echo '=====> Waiting for Mongo...';
        sleep 1;
      done;
      echo \"=====> Initiating ReplSet $$MONGODB_REPLICA_SET_NAME at mongodb:27017...\";
      mongosh --eval \"rs.initiate({_id: '$$MONGODB_REPLICA_SET_NAME', members: [{ _id: 0, host: 'mongodb:27017' }]})\";
      echo '=====> ReplSet done.';
      wait
      "
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping').ok === 1 && rs.status().ok === 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 25s
    deploy:
      resources:
        limits:
          memory: ${MONGODB_MEMORY_LIMIT:-1536m}
    networks:
      - backend

  # --- Jitsi Meet (video/voice, screen share). Accessed via Caddy only. ---
  web:
    image: jitsi/web:${JITSI_IMAGE_VERSION:-unstable}
    restart: unless-stopped
    expose:
      - "80"
    volumes:
      - ${CONFIG:-./jitsi-cfg}/web:/config:Z
      - ${CONFIG:-./jitsi-cfg}/web/crontabs:/var/spool/cron/crontabs:Z
      - ${CONFIG:-./jitsi-cfg}/transcripts:/usr/share/jitsi-meet/transcripts:Z
    env_file: .env
    environment:
      - PUBLIC_URL
      - TZ
      - ENABLE_LETSENCRYPT
      - LETSENCRYPT_DOMAIN
      - LETSENCRYPT_EMAIL
      - DISABLE_HTTPS
      - XMPP_DOMAIN
      - XMPP_BOSH_URL_BASE
      - XMPP_AUTH_DOMAIN
      - XMPP_MUC_DOMAIN
      - XMPP_GUEST_DOMAIN
    depends_on:
      - jvb
    deploy:
      resources:
        limits:
          memory: ${JITSI_WEB_MEMORY_LIMIT:-256m}
    networks:
      - meet.jitsi

  prosody:
    image: jitsi/prosody:${JITSI_IMAGE_VERSION:-unstable}
    restart: unless-stopped
    volumes:
      - ${CONFIG:-./jitsi-cfg}/prosody/config:/config:Z
      - ${CONFIG:-./jitsi-cfg}/prosody/prosody-plugins-custom:/prosody-plugins-custom:Z
    env_file: .env
    environment:
      - AUTH_TYPE
      - ENABLE_AUTH
      - ENABLE_GUESTS
      - XMPP_DOMAIN
      - XMPP_AUTH_DOMAIN
      - XMPP_GUEST_DOMAIN
      - XMPP_MUC_DOMAIN
      - XMPP_INTERNAL_MUC_DOMAIN
      - XMPP_RECORDER_DOMAIN
      - JICOFO_AUTH_PASSWORD
      - JVB_AUTH_PASSWORD
      - JIGASI_XMPP_PASSWORD
      - JIGASI_TRANSCRIBER_PASSWORD
      - JIBRI_RECORDER_PASSWORD
      - JIBRI_XMPP_PASSWORD
      - PUBLIC_URL
      - XMPP_SERVER
      - TZ
    deploy:
      resources:
        limits:
          memory: ${JITSI_PROSODY_MEMORY_LIMIT:-256m}
    networks:
      meet.jitsi:
        aliases:
          - ${XMPP_SERVER:-xmpp.meet.jitsi}

  jicofo:
    image: jitsi/jicofo:${JITSI_IMAGE_VERSION:-unstable}
    restart: unless-stopped
    volumes:
      - ${CONFIG:-./jitsi-cfg}/jicofo:/config:Z
    env_file: .env
    environment:
      - XMPP_DOMAIN
      - XMPP_AUTH_DOMAIN
      - XMPP_INTERNAL_MUC_DOMAIN
      - XMPP_MUC_DOMAIN
      - XMPP_SERVER
      - JICOFO_AUTH_PASSWORD
      - JVB_BREWERY_MUC
      - JVB_AUTH_PASSWORD
      - TZ
    depends_on:
      - prosody
    deploy:
      resources:
        limits:
          memory: ${JICOFO_MEMORY_LIMIT:-512m}
    networks:
      - meet.jitsi

  jvb:
    image: jitsi/jvb:${JITSI_IMAGE_VERSION:-unstable}
    restart: unless-stopped
    ports:
      - "${JVB_PORT:-10000}:${JVB_PORT:-10000}/udp"
      - "127.0.0.1:${JVB_COLIBRI_PORT:-8080}:8080"
    volumes:
      - ${CONFIG:-./jitsi-cfg}/jvb:/config:Z
    env_file: .env
    environment:
      - DOCKER_HOST_ADDRESS
      - PUBLIC_URL
      - JVB_AUTH_USER
      - JVB_AUTH_PASSWORD
      - JVB_BREWERY_MUC
      - XMPP_AUTH_DOMAIN
      - XMPP_INTERNAL_MUC_DOMAIN
      - XMPP_SERVER
      - JVB_PORT
      - JVB_ADVERTISE_IPS
      - TZ
    depends_on:
      - prosody
    deploy:
      resources:
        limits:
          memory: ${JVB_MEMORY_LIMIT:-3g}
    networks:
      - meet.jitsi

volumes:
  mongodb_data:
  caddy_data:
  caddy_config:

networks:
  backend:
    driver: bridge
  meet.jitsi:
    driver: bridge
